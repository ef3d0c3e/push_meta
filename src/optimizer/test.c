#include "quicksort/quicksort.h"
#include <optimizer/optimizer.h>
#include <string.h>

static inline void test(optimizer_conf_t cfg, const int *array, size_t size)
{
	state_t state = state_new(size);
	memcpy(state.sa.data, array, sizeof(int) * size);
	state.sa.size = size;

	quicksort_config_t qcfg = {
		.search_depth = 0,

		.nm_max_iters = 50,
		.nm_tol = 1e-3f,
		.nm_initial_scale = 0.5f,
		.nm_final_radius = 2,
	};

	sort_quicksort(&qcfg, &state);
	assert(state.sa.size == size);
	assert(state.sb.size == 0);
	assert(stack_is_sorted(&state.sa));

	state_t optimized = optimize(&state, cfg);
	assert(optimized.sa.size == size);
	assert(optimized.sb.size == 0);
	assert(stack_is_sorted(&optimized.sa));
	state_destroy(&optimized);
	state_destroy(&state);
}

void
optimizer_test(void)
{
	static const int perms_2[2][2] = { { 1, 2 }, { 2, 1 } };
	static const int perms_3[6][3] = { { 1, 2, 3 }, { 2, 1, 3 }, { 3, 1, 2 },
		                               { 1, 3, 2 }, { 2, 3, 1 }, { 3, 2, 1 } };
	static const int perms_4[24][4] = {
		{ 1, 2, 3, 4 }, { 2, 1, 3, 4 }, { 3, 1, 2, 4 }, { 1, 3, 2, 4 }, { 2, 3, 1, 4 },
		{ 3, 2, 1, 4 }, { 3, 2, 4, 1 }, { 2, 3, 4, 1 }, { 4, 3, 2, 1 }, { 3, 4, 2, 1 },
		{ 2, 4, 3, 1 }, { 4, 2, 3, 1 }, { 4, 1, 3, 2 }, { 1, 4, 3, 2 }, { 3, 4, 1, 2 },
		{ 4, 3, 1, 2 }, { 1, 3, 4, 2 }, { 3, 1, 4, 2 }, { 2, 1, 4, 3 }, { 1, 2, 4, 3 },
		{ 4, 2, 1, 3 }, { 2, 4, 1, 3 }, { 1, 4, 2, 3 }, { 4, 1, 2, 3 },
	};
	static const int perms_5[120][5] = {
		{ 1, 2, 3, 4, 5 }, { 2, 1, 3, 4, 5 }, { 3, 1, 2, 4, 5 }, { 1, 3, 2, 4, 5 },
		{ 2, 3, 1, 4, 5 }, { 3, 2, 1, 4, 5 }, { 3, 2, 4, 1, 5 }, { 2, 3, 4, 1, 5 },
		{ 4, 3, 2, 1, 5 }, { 3, 4, 2, 1, 5 }, { 2, 4, 3, 1, 5 }, { 4, 2, 3, 1, 5 },
		{ 4, 1, 3, 2, 5 }, { 1, 4, 3, 2, 5 }, { 3, 4, 1, 2, 5 }, { 4, 3, 1, 2, 5 },
		{ 1, 3, 4, 2, 5 }, { 3, 1, 4, 2, 5 }, { 2, 1, 4, 3, 5 }, { 1, 2, 4, 3, 5 },
		{ 4, 2, 1, 3, 5 }, { 2, 4, 1, 3, 5 }, { 1, 4, 2, 3, 5 }, { 4, 1, 2, 3, 5 },
		{ 5, 1, 2, 3, 4 }, { 1, 5, 2, 3, 4 }, { 2, 5, 1, 3, 4 }, { 5, 2, 1, 3, 4 },
		{ 1, 2, 5, 3, 4 }, { 2, 1, 5, 3, 4 }, { 2, 1, 3, 5, 4 }, { 1, 2, 3, 5, 4 },
		{ 3, 2, 1, 5, 4 }, { 2, 3, 1, 5, 4 }, { 1, 3, 2, 5, 4 }, { 3, 1, 2, 5, 4 },
		{ 3, 5, 2, 1, 4 }, { 5, 3, 2, 1, 4 }, { 2, 3, 5, 1, 4 }, { 3, 2, 5, 1, 4 },
		{ 5, 2, 3, 1, 4 }, { 2, 5, 3, 1, 4 }, { 1, 5, 3, 2, 4 }, { 5, 1, 3, 2, 4 },
		{ 3, 1, 5, 2, 4 }, { 1, 3, 5, 2, 4 }, { 5, 3, 1, 2, 4 }, { 3, 5, 1, 2, 4 },
		{ 4, 5, 1, 2, 3 }, { 5, 4, 1, 2, 3 }, { 1, 4, 5, 2, 3 }, { 4, 1, 5, 2, 3 },
		{ 5, 1, 4, 2, 3 }, { 1, 5, 4, 2, 3 }, { 1, 5, 2, 4, 3 }, { 5, 1, 2, 4, 3 },
		{ 2, 1, 5, 4, 3 }, { 1, 2, 5, 4, 3 }, { 5, 2, 1, 4, 3 }, { 2, 5, 1, 4, 3 },
		{ 2, 4, 1, 5, 3 }, { 4, 2, 1, 5, 3 }, { 1, 2, 4, 5, 3 }, { 2, 1, 4, 5, 3 },
		{ 4, 1, 2, 5, 3 }, { 1, 4, 2, 5, 3 }, { 5, 4, 2, 1, 3 }, { 4, 5, 2, 1, 3 },
		{ 2, 5, 4, 1, 3 }, { 5, 2, 4, 1, 3 }, { 4, 2, 5, 1, 3 }, { 2, 4, 5, 1, 3 },
		{ 3, 4, 5, 1, 2 }, { 4, 3, 5, 1, 2 }, { 5, 3, 4, 1, 2 }, { 3, 5, 4, 1, 2 },
		{ 4, 5, 3, 1, 2 }, { 5, 4, 3, 1, 2 }, { 5, 4, 1, 3, 2 }, { 4, 5, 1, 3, 2 },
		{ 1, 5, 4, 3, 2 }, { 5, 1, 4, 3, 2 }, { 4, 1, 5, 3, 2 }, { 1, 4, 5, 3, 2 },
		{ 1, 3, 5, 4, 2 }, { 3, 1, 5, 4, 2 }, { 5, 1, 3, 4, 2 }, { 1, 5, 3, 4, 2 },
		{ 3, 5, 1, 4, 2 }, { 5, 3, 1, 4, 2 }, { 4, 3, 1, 5, 2 }, { 3, 4, 1, 5, 2 },
		{ 1, 4, 3, 5, 2 }, { 4, 1, 3, 5, 2 }, { 3, 1, 4, 5, 2 }, { 1, 3, 4, 5, 2 },
		{ 2, 3, 4, 5, 1 }, { 3, 2, 4, 5, 1 }, { 4, 2, 3, 5, 1 }, { 2, 4, 3, 5, 1 },
		{ 3, 4, 2, 5, 1 }, { 4, 3, 2, 5, 1 }, { 4, 3, 5, 2, 1 }, { 3, 4, 5, 2, 1 },
		{ 5, 4, 3, 2, 1 }, { 4, 5, 3, 2, 1 }, { 3, 5, 4, 2, 1 }, { 5, 3, 4, 2, 1 },
		{ 5, 2, 4, 3, 1 }, { 2, 5, 4, 3, 1 }, { 4, 5, 2, 3, 1 }, { 5, 4, 2, 3, 1 },
		{ 2, 4, 5, 3, 1 }, { 4, 2, 5, 3, 1 }, { 3, 2, 5, 4, 1 }, { 2, 3, 5, 4, 1 },
		{ 5, 3, 2, 4, 1 }, { 3, 5, 2, 4, 1 }, { 2, 5, 3, 4, 1 }, { 5, 2, 3, 4, 1 },
	};

	optimizer_conf_t cfg = {
		.search_depth = 5,
		.search_width = 1000,
	};
	for (size_t i = 0; i < sizeof(perms_2)/sizeof(perms_2[0]); ++i)
		test(cfg, perms_2[i], sizeof(perms_2[i])/sizeof(perms_2[i][0]));
	for (size_t i = 0; i < sizeof(perms_3)/sizeof(perms_3[0]); ++i)
		test(cfg, perms_3[i], sizeof(perms_3[i])/sizeof(perms_3[i][0]));
	for (size_t i = 0; i < sizeof(perms_4)/sizeof(perms_4[0]); ++i)
		test(cfg, perms_4[i], sizeof(perms_4[i])/sizeof(perms_4[i][0]));
	for (size_t i = 0; i < sizeof(perms_5)/sizeof(perms_5[0]); ++i)
		test(cfg, perms_5[i], sizeof(perms_5[i])/sizeof(perms_5[i][0]));
}
